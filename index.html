<!DOCTYPE html>
<html>
  <head>
    <title>Chart?</title>
    <script src="//cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.bundle.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/date-fns/1.26.0/date_fns.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>
  </head>
  <body style="padding: 0; margin: 0;">
    <canvas id="chart" style="width: 100%; height: auto !important" height="600"></canvas>
    <script>
      const initialData = {
        dataset: []
      }
      const options = {
        maintainAspectRatio: false
      }
      const chart = new Chart('chart', { type: 'line', data: initialData, options: options });

      function reducePoints(lastValue, item) {
        const key = dateFns.format(item.time, 'YYYY-MM-DD');
        if (lastValue.hasOwnProperty(key)) {
          lastValue[key] += 1;
        } else {
          lastValue[key] = 1;
        }
        return lastValue;
      }

      window.addEventListener('resize', () => {
        chart.render();
      });

      fetch('https://stats.lkng.me/pocket?all=true&inc=false')
        .then(response => response.json())
        .then(response => {
          const added = _.reduce(_.get(response.data['/pocket'], 'views'), reducePoints, {})
          const archived = _.reduce(_.get(response.data['/pocket/archive'], 'views'), reducePoints, {})

          chart.data.labels = _([])
            .concat(_.keys(added))
            .concat(_.keys(archived))
            .uniq()
            .value();

          chart.data.datasets = [
            {
              label: 'Articles added to pocket',
              data: _.map(chart.data.labels, key => added[key] || 0),
              borderColor: '#c2e0c6',
            },
            {
              label: 'Articles archived in pocket',
              data: _.map(chart.data.labels, key => archived[key] || 0),
              borderColor: '#d4c5f9',
            }
          ];
          chart.update();
        });

    </script>
  </body>
</html>
